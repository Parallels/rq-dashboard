{% extends "rq_dashboard/base.html" %}

{% block content %}
<div class="span12">
    <div class="section">

        <h1>Workers <a id="workers-btn" href="#">(toggle)</a></h1>

        <p id="workers-count" class="fixed intro">No workers registered!</p>

        <table id="workers" class="table table-bordered" style="display: none;">
            <thead>
            <tr>
                <th style="width:48px">State</th>
                <th>Worker</th>
                <th>Queues</th>
            </tr>
            </thead>
            <tbody>
            <tr data-role="loading-placeholder">
                <td colspan="3">Loading...</td>
            </tr>
            </tbody>
        </table>

        <script name="worker-row" type="text/template">
            <tr data-role="worker">
                <td><i class="icon-<%= d.state %>" title="Job ID: <%= d.current_job.job_id %>&#013;&#010;Description: <% if (d.current_job.description){ %> <%- d.current_job.description %> <% } %>&#013;&#010;Created at: <%= d.current_job.created_at %>&#013;&#010;"></i></td>
                <td <% if (d.version && d.python_version) { %>title ="RQ <%= d.version %> / Python <%= d.python_version %>" <% } %>><%= d.name %></td>
                <td><%= d.queues.join(', ') %></td>
            </tr>
        </script>

        <script name="no-workers-row" type="text/template">
            <tr>
                <td colspan="3">No workers.</td>
            </tr>
        </script>

    </div>
</div>

{% endblock %}


{% block inline_js %}
//
// WORKERS
//
(function($) {
    var $raw_tpl = $('script[name=worker-row]').html();
    var noWorkersHtml = $('script[name=no-workers-row]').html();
    var template = _.template($raw_tpl);
    var $tbody = $('table#workers tbody');
    var $placeholderEl = $('tr[data-role=loading-placeholder]', $tbody);

    var reload_table = function(done) {
        $placeholderEl.show();

        // Fetch the available workers
        api.getWorkers(function(workers, err) {
            // Return immediately in case of error
            if (err) {
                if (done !== undefined) {
                    done(0);
                }
                return;
            }

            var html = '';

            $tbody.empty();

            if (workers.length > 0) {
                $('#workers-count').html(workers.length + ' workers registered')

                $.each(workers, function(i, worker) {
                    if (worker.state === 'busy') {
                        worker.state = 'play';
                    } else {
                        worker.state = 'pause';
                    }
                    html += template({d: worker}, {variable: 'd'});
                });
                $tbody.append(html);
            } else {
                $('#workers-count').html('No workers registered!')
                $tbody.append(noWorkersHtml);
            }

            if (done !== undefined) {
                done(workers.length);
            }
        });
    };

    var refresh_table_loop = function() {
        $('span.loading').fadeIn('fast');
        reload_table(function() {
            $('span.loading').fadeOut('fast');
            setTimeout(refresh_table_loop, POLL_INTERVAL);
        });
    };

    $(document).ready(function() {
        reload_table(function(workers_count) {
            $('#refresh-button').click(reload_table);
            // Hide list of workers If It's long
            if (workers_count > 8) {  // magic constant, need to think It through
                $('#workers').hide();
            } else {
                $('#workers').show();
            }
            // Start refreshing the list in a loop
            refresh_table_loop();
        });
    });
})($);


{% endblock%}
